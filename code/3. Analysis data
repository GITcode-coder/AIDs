——————————————————————
Extract the median survival time at a fixed time
——————————————————————
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
library(survival)
library(data.table)
K
n<-500
C<-list()
sur<-list()
sur_med<-list()
year<-c(156,6,12,24,60,96,120)
  cl <- makeCluster(8-1) 
registerDoParallel(cl)
job::job({
for(m in 1:3){
sur_95<-c(0)
sur_med_95<-c(0)
for(or in 1:7){#(K+1)
  surv_p<-matrix(NA, nrow=100, ncol=K)
  surv_p_med<-c(NA)
for(cycle in 1:100){
kk<-year[or] 

#1. Generate data chain
 p_k<- p_list
  if(or>1){p_k[,,(kk:(K-1))]<- p_list_tr[,,(kk:(K-1))]}
data<- as.data.frame(NA, nrow = n, ncol = K)
data<- foreach(i = 1:n,
               .combine = rbind,
               .errorhandling = "pass") %dopar% {
current_state <- ifelse(i<=n0,1,2)
  da<-c(current_state)
  # Store sample sequences
  for(t in 1:(K-1)){
    next_state <- sample(1:states, 1, prob = p_k[current_state,,t])
  da<- c(da,next_state)
  current_state<-next_state
  }
  return(da)
               }
data<-as.data.frame(data)

#2.Extract survival data
num<-dim(data)[1]
k0<-dim(data)[2]
c_1<-foreach(i = 1:n0,
               .combine = rbind,
             .packages = c("dplyr"),
               .errorhandling = "pass") %dopar% {
                 c<-c(rep(0, 4))
                 Time<-c(rep(1, k0))
                 s<-c(rep(0, k0))
                 d<-as.numeric(data[i,])
                 sit<-min(which(is.na(d)==FALSE))#if have NA
for(t in sit:(k0-1)){
 
  Time[t+1]<-ifelse(d[t]==d[t+1],Time[t]+1,1)
  
  if ((d[t]==1)&(d[t+1]==2)) {s[t]<-1}
  else if ((d[t]==2)&(d[t+1]==1)) {s[t]<-2}
  else if ((d[t]==1)&(d[t+1]==3)) {s[t]<-3} 
  else if ((d[t]==2)&(d[t+1]==3)) {s[t]<-4}
  else s[t]<-0
  }

  Time<-Time[sit:k0]
  s<-s[sit:k0]
if (any(s!= 0)==TRUE) {#transfer has occurred
  for(l in 1:(sum(s!= 0))){#sum(s! = 0) denote the number of transitions occurred
    ci<-c(ID=i,y=Time[which(s!= 0)][l],m=s[which(s!= 0)][l],sigema=1)
    ci<-as.data.frame(t(ci))
    colnames(ci)<-c("ID","y","m","sigema")
    c<-rbind(c,ci)
  }

    if(last(Time)>1){# No transfer occurred at the last point in time
    if(last(d)==1|last(d)==2){## The last status is not dead, indicating that there is censoring data
   ci2<-c(ID=i,y=last(Time)-1,m=last(d),sigema=0)
   ci3<-c(ID=i,y=last(Time)-1,m=last(d)+2,sigema=0)
   #m=1 in the last time correspond the censoring data of m=1/m=3;
   #m=2 in the last time correspond the censoring data of m=2/m=4
  
   ci2<-as.data.frame(t(ci2))
   ci3<-as.data.frame(t(ci3))
    colnames(ci2)<-c("ID","y","m","sigema")
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-rbind(c,ci2,ci3)
  }
    }
     }#If last(time) is greater than 1 and is not in state 3, then the survival time of the individual in state 1/2 is the censoring data and the survival time is last(time)-1
 if (any(s!= 0)==FALSE) {
  ci1<-c(ID=i,y=last(Time)-1,m=last(d),sigema=0)
  ci2<-c(ID=i,y=last(Time)-1,m=last(d)+2,sigema=0)
  ci1<-as.data.frame(t(ci1))
  ci2<-as.data.frame(t(ci2))
    colnames(ci1)<-c("ID","y","m","sigema")
    colnames(ci2)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci1,ci2))
 }
#pfs/pd-d
   if(last(d)==1|last(d)==2){
    ci3<-c(ID=i,y=K-sit,m=5,sigema=0) 
     ci3<-as.data.frame(t(ci3))
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci3))  
   }
  if(last(d)==3){ 
   if(d[sit]==1|d[sit]==2){
ci3<-c(ID=i,y=min(which(d==3))-sit,m=5,sigema=1)
ci3<-as.data.frame(t(ci3))
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci3))  
   }
   if(d[sit]==3){ 
   c<-c
   }
  }
  c<-c[-1,]
                 return(c)
               }
C_1<-c_1[which((c_1$m==1)|(c_1$m==5)),]
if(length(which(C_1$m==5))>0){C_1[which(C_1$m==5),3]<-2}

c_2<-foreach(i = (n0+1):n,
               .combine = rbind,
             .packages = c("dplyr"),
               .errorhandling = "pass") %dopar% {
                 c<-c(rep(0, 4))
                 Time<-c(rep(1, k0))
                 s<-c(rep(0, k0))
                 d<-as.numeric(data[i,])
                 sit<-min(which(is.na(d)==FALSE))#if have NA
for(t in sit:(k0-1)){

  Time[t+1]<-ifelse(d[t]==d[t+1],Time[t]+1,1)
 
  if ((d[t]==1)&(d[t+1]==2)) {s[t]<-1}
  else if ((d[t]==2)&(d[t+1]==1)) {s[t]<-2}
  else if ((d[t]==1)&(d[t+1]==3)) {s[t]<-3} 
  else if ((d[t]==2)&(d[t+1]==3)) {s[t]<-4}
  else s[t]<-0
  }

  Time<-Time[sit:k0]
  s<-s[sit:k0]

   if(last(d)==1|last(d)==2){
    ci3<-c(ID=i,y=K-sit,m=5,sigema=0) 
     ci3<-as.data.frame(t(ci3))
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci3))  
   }
  if(last(d)==3){ 
   if(d[sit]==1|d[sit]==2){
ci3<-c(ID=i,y=min(which(d==3))-sit,m=5,sigema=1)
ci3<-as.data.frame(t(ci3))
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci3))  
   }
   if(d[sit]==3){ 
   c<-c
   }
  }
  c<-c[-1,]
                 return(c)
               }
C_2<-c_2[which(c_2$m==5),]
if(length(which(C_2$m==5))>0){C_2[,3]<-3}
C_1<-rbind(C_1,C_2)

# 3. Fit the weibull estimation
data_sur<-C_1[which(C_1$m==m),c(2,4)]
weibull_fit <- survreg(Surv(y, sigema) ~ 1, data = data_sur, dist = "weibull")

scale <- exp(weibull_fit$coefficients) 
shape <- 1/weibull_fit$scale            
t <-1:K
surv_prob <- exp(-(t/scale)^shape)
#plot(surv_prob,type="l")
surv_p[cycle,]<-surv_prob

#4. Extract the median survival time
data_sur<-C_1[which(C_1$m==m),c(2,4)]
fit <- survfit(Surv(y, sigema) ~ 1, data = data_sur)
surv_p_med[cycle]<- summary(fit)$table["median"]
}
#p
mean<-apply(surv_p,2,function(x){mean(x)})
lwr<-apply(surv_p,2,function(x){binom.test(sum(round(x,2)*100), 100*100)$conf.int[1]})
upr<-apply(surv_p,2,function(x){binom.test(sum(round(x,2)*100), 100*100)$conf.int[2]})
sur_95<-cbind(sur_95,mean,lwr,upr)
mean_med<-t.test(surv_p_med)$estimate
lwr_med<-t.test(surv_p_med)$conf.int[1]
upr_med<-t.test(surv_p_med)$conf.int[2]
sur_med_95<-rbind(sur_med_95,c(mean_med,lwr_med,upr_med))

}
 sur[[m]]<-sur_95[,-1]
  sur_med[[m]]<-sur_med_95[-1,]
}
},title="job2")
stopCluster(cl)
write.csv(sur,"~/Desktop/AIDS/AIDS-2024/beta_2nd/figure2_sur_2.csv")
write.csv(sur_med,"~/Desktop/AIDS/AIDS-2024/beta_2nd/figure2_sur_med.csv")

——————————————————————
Extract all median survival times
——————————————————————

library(foreach)
library(iterators)
library(parallel)
library(doParallel)
library(survival)
library(data.table)
sit<-apply(dat_flw,1,function(x){min(which(is.na(x)==FALSE))})
first<-c()
for(i in 1:length(sit)){
  first[i]<-dat_flw[i,sit[i]]
}
p1<-(table(first)/length(sit))[1]

#1. Generate data chain
cl <- makeCluster(8-1) 
registerDoParallel(cl)
job::job({
med_all<-list()
states<- 3  # number of states
n<-500 # The number of samples n<-5000
n0<-round(n*p1,0)
K# the number of loops
for(m in 1){
med_all_95<-c(0)
for(kk in 1:K){#(K+1)
  surv_p_med<-c(NA)
for(cycle in 1:10){
#生成data chain
 p_k<- p_list
 if(kk<K) {p_k[,,(kk:(K-1))]<- p_list_tr[,,(kk:(K-1))]}
data<- as.data.frame(NA, nrow = n, ncol = K)
data<- foreach(i = 1:n,
               .combine = rbind,
               .errorhandling = "pass") %dopar% {
current_state <- ifelse(i<=n0,1,2)
  da<-c(current_state)
  # Store sample sequences
  for(t in 1:(K-1)){
    next_state <- sample(1:states, 1, prob = p_k[current_state,,t])
  da<- c(da,next_state)
  current_state<-next_state
  }
  return(da)
               }
data<-as.data.frame(data)

num<-dim(data)[1]
k0<-dim(data)[2]
c_1<-foreach(i = 1:n0,
               .combine = rbind,
             .packages = c("dplyr"),
               .errorhandling = "pass") %dopar% {
                 c<-c(rep(0, 4))
                 Time<-c(rep(1, k0))
                 s<-c(rep(0, k0))
                 d<-as.numeric(data[i,])
                 sit<-min(which(is.na(d)==FALSE))#if have NA
for(t in sit:(k0-1)){
 
  Time[t+1]<-ifelse(d[t]==d[t+1],Time[t]+1,1)

  if ((d[t]==1)&(d[t+1]==2)) {s[t]<-1}
  else if ((d[t]==2)&(d[t+1]==1)) {s[t]<-2}
  else if ((d[t]==1)&(d[t+1]==3)) {s[t]<-3} 
  else if ((d[t]==2)&(d[t+1]==3)) {s[t]<-4}
  else s[t]<-0
  }

  Time<-Time[sit:k0]
  s<-s[sit:k0]
if (any(s!= 0)==TRUE) {#transfer has occurred
  for(l in 1:(sum(s!= 0))){#sum(s! = 0) denote the number of transitions occurred
    ci<-c(ID=i,y=Time[which(s!= 0)][l],m=s[which(s!= 0)][l],sigema=1)
    ci<-as.data.frame(t(ci))
    colnames(ci)<-c("ID","y","m","sigema")
    c<-rbind(c,ci)
  }

    if(last(Time)>1){# No transfer occurred at the last point in time
    if(last(d)==1|last(d)==2){## The last status is not dead, indicating that there is censoring data
   ci2<-c(ID=i,y=last(Time)-1,m=last(d),sigema=0)
   ci3<-c(ID=i,y=last(Time)-1,m=last(d)+2,sigema=0)
   #m=1 in the last time correspond the censoring data of m=1/m=3;
   #m=2 in the last time correspond the censoring data of m=2/m=4
  
   ci2<-as.data.frame(t(ci2))
   ci3<-as.data.frame(t(ci3))
    colnames(ci2)<-c("ID","y","m","sigema")
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-rbind(c,ci2,ci3)
  }
    }
     }#If last(time) is greater than 1 and is not in state 3, then the survival time of the individual in state 1/2 is the censoring data and the survival time is last(time)-1
 if (any(s!= 0)==FALSE) {
  ci1<-c(ID=i,y=last(Time)-1,m=last(d),sigema=0)
  ci2<-c(ID=i,y=last(Time)-1,m=last(d)+2,sigema=0)
  ci1<-as.data.frame(t(ci1))
  ci2<-as.data.frame(t(ci2))
    colnames(ci1)<-c("ID","y","m","sigema")
    colnames(ci2)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci1,ci2))
 }
#pfs/pd-d
   if(last(d)==1|last(d)==2){
    ci3<-c(ID=i,y=K-sit,m=5,sigema=0) 
     ci3<-as.data.frame(t(ci3))
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci3))  
   }
  if(last(d)==3){ 
   if(d[sit]==1|d[sit]==2){
ci3<-c(ID=i,y=min(which(d==3))-sit,m=5,sigema=1)
ci3<-as.data.frame(t(ci3))
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci3))  
   }
   if(d[sit]==3){ 
   c<-c
   }
  }
  c<-c[-1,]
                 return(c)
               }
C_1<-c_1[which((c_1$m==1)|(c_1$m==5)),]
if(length(which(C_1$m==5))>0){C_1[which(C_1$m==5),3]<-2}

c_2<-foreach(i = (n0+1):n,
               .combine = rbind,
             .packages = c("dplyr"),
               .errorhandling = "pass") %dopar% {
                 c<-c(rep(0, 4))
                 Time<-c(rep(1, k0))
                 s<-c(rep(0, k0))
                 d<-as.numeric(data[i,])
                 sit<-min(which(is.na(d)==FALSE))#if have NA
for(t in sit:(k0-1)){
  
  Time[t+1]<-ifelse(d[t]==d[t+1],Time[t]+1,1)

  if ((d[t]==1)&(d[t+1]==2)) {s[t]<-1}
  else if ((d[t]==2)&(d[t+1]==1)) {s[t]<-2}
  else if ((d[t]==1)&(d[t+1]==3)) {s[t]<-3} 
  else if ((d[t]==2)&(d[t+1]==3)) {s[t]<-4}
  else s[t]<-0
  }
 
  Time<-Time[sit:k0]
  s<-s[sit:k0]
#pfs/pd-d
   if(last(d)==1|last(d)==2){
    ci3<-c(ID=i,y=K-sit,m=5,sigema=0) 
     ci3<-as.data.frame(t(ci3))
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci3))  
   }
  if(last(d)==3){ 
   if(d[sit]==1|d[sit]==2){
ci3<-c(ID=i,y=min(which(d==3))-sit,m=5,sigema=1)
ci3<-as.data.frame(t(ci3))
    colnames(ci3)<-c("ID","y","m","sigema")
    c<-as.data.frame(rbind(c,ci3))  
   }
   if(d[sit]==3){ 
   c<-c
   }
  }
  c<-c[-1,]
                 return(c)
               }
C_2<-c_2[which(c_2$m==5),]
if(length(which(C_2$m==5))>0){C_2[,3]<-3}
C_1<-rbind(C_1,C_2)

#2.Extract the median survival time
# Fit the Kaplan-Meier estimation
data_sur<-C_1[which(C_1$m==m),c(2,4)]
fit <- survfit(Surv(y, sigema) ~ 1, data = data_sur)
surv_p_med[cycle]<- summary(fit)$table["median"]
}
mean_med<-t.test(surv_p_med)$estimate
lwr_med<-t.test(surv_p_med)$conf.int[1]
upr_med<-t.test(surv_p_med)$conf.int[2]
med_all_95<-rbind(med_all_95,c(mean_med,lwr_med,upr_med))
}
  med_all[[m]]<-med_all_95[-1,]
}
write.csv(med_all,"~/Desktop/AIDS/AIDS-2024/beta_2nd/figure3_med_all.csv")
  },title="job1")
stopCluster(cl)



