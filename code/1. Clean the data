library(readxl)
flw_use<- read_excel("Desktop/AIDS/数据/AIDS-2024/flw_use.xlsx")
colnames(flw_use)<-c("id","flw_sta","flw_num","x","cd4","date")
#head(flw_use)#152930

#1. Rule out loss to follow-up
flw<-flw_use[-(which(flw_use$flw_sta=="失访"|flw_use$flw_sta=="查无此人（以后无需随访）")),]#149679

#2. Corresponding month k (starting from 2012)
library("lubridate")
flw$year<-year(flw$date)
flw$month<-month(flw$date)
#table(flw$year)
flw<-flw[which(flw$year>=2012),]#142967
flw$k<-(flw$year-2012)*12+flw$month


#3. cd4 status classification
flw$status<-flw$cd4
flw$status[which(flw$cd4>=200)]<-1
flw$status[which(flw$cd4<200)]<-2
flw$status[which(flw$flw_sta=="死亡")]<-3
table(flw$status)
colnames(flw)

num=length(unique(flw$id))
K=max(flw$k)
dat<-matrix(NA,nrow=num,ncol=K+1)
dim(flw)
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
n.cores <- detectCores()
n.cores
cl <- makeCluster(n.cores-1) 
registerDoParallel(cl)
id=flw$id
status=flw$status
k=flw$k
dat<-foreach(i = 1:num,
           .combine = rbind,
               .errorhandling = "pass") %dopar% {
    c<-rep(NA,K)
    row<-which(id==unique(id)[i]) 
    stat<-status[row]
    k0<-k[row]
    for(m in k0){
      c[k0]<-ifelse(is.na(c[k0])==TRUE,stat,c[k0])
    }
     d<-c(unique(id)[i],c)            
   return(d)             
               } 
stopCluster(cl)
dat<-as.data.frame(dat)
colnames(dat)<-c("id",1:K) #7271

#3.included in repeated measurements>=Three times
times<-apply(dat[,-1],1,function(x){if(length(which(is.na(x)==FALSE))>=3){return(1)}
  return(0)})
table(times)
dat_1<-dat[which(times==1),]#6157

#4. Entry age, excluding People aged<10； >65
card_use<- read_excel("Desktop/AIDS/数据/AIDS-2024/card_use.xlsx")
colnames(card_use)
card<-card_use[,c(1,11,74,75)]#9095
colnames(card)<-c("id","born","die_cause","die_cause_2")
card$born_year<-year(card$born)
table(card$born_year)
card<-card[which(card$born_year<2002),]#8973
card<-card[which(card$born_year>=1947),]#8487

#5. Exclude those who died accidentally
table(card$die_cause_2)
card<-card[-which((card$die_cause=="艾滋病无关死亡")&((card$die_cause_2=="自杀")|(card$die_cause_2=="吸毒过量")|(card$die_cause_2=="其他非疾病外因死亡(损伤等)"))),]#8366

——————————
dat_2<-merge(dat_1,card[,1],by="id")#5739
colnames(dat_2)
cl <- makeCluster(n.cores-1) 
registerDoParallel(cl)
num=dim(dat_2)[1]
K=max(flw$k)
dat_3<-foreach(i = 1:num,
           .combine = rbind,
               .errorhandling = "pass") %dopar% {
 c<-dat_2[i,]                
 sit<-min(which(is.na(c[-1])==FALSE))
 c0<-c[-1]
 for(m in (sit+1):K){
   c0[m]<-ifelse(is.na(c0[m])==TRUE,c0[m-1],c0[m])
 }
 c[-1]<-c0
 return(c)
}
stopCluster(cl) 
dim(dat_3)#5739
colnames(dat_3)<-c("id",1:K) 
write.csv(dat_3,"~/Desktop/AIDS/数据/AIDS-2024/dat_flw.csv")




————————————
#Variable division of x
flw$X<-flw$x
flw$X[which(flw$x<=3)]<-1
flw$X[which(flw$x>3)]<-0
table(flw$X)
num=length(unique(flw$id))
K=max(flw$k)
X_1<-matrix(NA,nrow=num,ncol=K+1)
dim(flw)
cl <- makeCluster(n.cores-1) 
registerDoParallel(cl)
id=flw$id
x=flw$X
k=flw$k
X_1<-foreach(i = 1:num,
           .combine = rbind,
               .errorhandling = "pass") %dopar% {
    c<-rep(NA,K)
    row<-which(id==unique(id)[i]) 
    x0<-x[row]
    k0<-k[row]
    for(m in k0){
      c[k0]<-ifelse(is.na(c[k0])==TRUE,x0,c[k0])
    }
     d<-c(unique(id)[i],c)            
   return(d)             
               } 
stopCluster(cl)
X_1<-as.data.frame(X_1)
colnames(X_1)<-c("id",1:K) 
X_2<-merge(X_1,dat_3,by="id")#5739
X_2<-X_2[1:(K+1)]
colnames(X_2)<-c("id",1:K) 
X_2[,-1]<-apply(X_2[,-1],2,function(x){as.numeric(x)})
X_2<-as.data.frame(X_2)
cl <- makeCluster(n.cores-1) 
registerDoParallel(cl)
num=dim(X_2)[1]
K=max(flw$k)
X_3<-foreach(i = 1:num,
           .combine = rbind,
               .errorhandling = "pass") %dopar% {
 c<-X_2[i,]                
 sit<-min(which(is.na(c[-1])==FALSE))
 c0<-c[-1]
 c0[1:sit]<-rep(c0[sit],sit)
 for(m in (sit+1):K){
   c0[m]<-ifelse(is.na(c0[m])==TRUE,c0[m-1],c0[m])
 }
 c[-1]<-c0
 return(c)
}
stopCluster(cl) 
X_3<-as.data.frame(X_3)
write.csv(X_3,"~/Desktop/AIDS/数据/AIDS-2024/dat_x.csv")
